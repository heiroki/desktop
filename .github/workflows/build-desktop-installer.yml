name: Build Desktop Installer

on:
  push:
    branches:
      - feature/desktopapp_test
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows-installer:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ========================================
      # ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆbashã‚·ã‚§ãƒ«ä½¿ç”¨ï¼‰
      # ========================================
      - name: Download AI Model from Release
        shell: bash
        run: |
          mkdir -p backend/models
          curl -L -o backend/models/gemma-2-2b-jpn-it-Q4_K_M.gguf \
             https://github.com/heiroki/desktop/releases/download/model-v1.0/gemma-2-2b-jpn-it-Q4_K_M.gguf
      
      # ========================================
      # Python + PyInstaller (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰exeåŒ–)
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build Backend with PyInstaller
        run: |
          cd backend
          python build.py
      
      # ========================================
      # Flutter Windows ãƒ“ãƒ«ãƒ‰
      # ========================================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Enable Flutter Windows Desktop
        run: |
          flutter config --enable-windows-desktop
          flutter doctor -v
      
      - name: Install Flutter dependencies
        run: |
          cd frontend/ai_desktop_app
          flutter pub get
      
      - name: Build Flutter Windows
        run: |
          cd frontend/ai_desktop_app
          flutter build windows --release
      
      # ========================================
      # Inno Setup (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ä½œæˆ)
      # ========================================
      - name: Install Inno Setup
        run: choco install innosetup -y
      
      - name: Create Installer with Inno Setup
        run: |
          iscc installer/setup.iss
      
      # ========================================
      # æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # ========================================
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: WindowsInstaller
          path: installer/output/*.exe
          retention-days: 30
      
      # ========================================
      # ãƒªãƒªãƒ¼ã‚¹ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # ========================================
      - name: Create Release (Optional)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Desktop App Installer v${{ github.run_number }}
          body: |
            ğŸš€ Windowsãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
            
            **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †:**
            1. `AIDesktopApp_Setup.exe` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            3. ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
          files: installer/output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}